{
    "id": "sapi-insert-vuln-count-postgres",
    "name": "Insert vulnerabilities",
    "pipeline": [
        {
            "action": "start",
            "data": {},
            "id": "start",
            "next_action": "sql_db_conn_vulnerabilities"
        },
        {
            "id": "sql_db_conn_vulnerabilities",
            "action": "sql_db",
            "data": {
                "conn_name": "socportal"
            },
            "next_action": "flow_var_contracts"
        },
        {
            "id": "flow_var_contracts",
            "action": "flow_var",
            "data": {
                "session": "${response.db.session}",
                "models": "${function.models}",
                "vuln_count_service": "${function.services.VulnerabilitiesCount}",
                "contracts": "${workspace.contracts}"
            },
            "next_action": "check_var_contracts"
        },
        {
            "id": "check_var_contracts",
            "action": "switch",
            "data": {
                "conditions": [
                    {
                        "operator": "greater_than",
                        "first_expression": "${len(flow.contracts)}",
                        "second_expression": "${0}",
                        "next_action": "workspace_var_contract"
                    }
                ],
                "next_action_else": "response_success"
            },
            "next_action": "${pipeline.next_action}"
        },  
        {
            "id": "workspace_var_contract",
            "action": "workspace_var",
            "data": {
                "contract": "${flow.contracts[0].contract}"
            },
            "next_action": "handle_sapi_get_vuln"
        },
        {
            "id": "handle_sapi_get_vuln",
            "action": "handle",
            "data": {
                "flow": "sapi-get-vuln"
            },
            "next_action": "flow_var_vulnerabilities"
        },
        {
            "id": "flow_var_vulnerabilities",
            "action": "flow_var",
            "data": {
                "vulnerabilities": "${workspace.vulnerabilities}"
            },
            "next_action": "handle_sapi_insert_vuln_postgres"
        },
        {
            "id": "handle_sapi_insert_vuln_postgres",
            "action": "handle",
            "data": {
                "flow": "sapi-insert-vuln-postgres"
            },
            "next_action": "check_var_vulnerabilities"
        },
        {
            "id": "check_var_vulnerabilities",
            "action": "switch",
            "data": {
                "conditions": [
                    {
                        "operator": "greater_than",
                        "first_expression": "${len(flow.vulnerabilities)}",
                        "second_expression": "${0}",
                        "next_action": "insert_vulnerabilities"
                    }
                ],
                "next_action_else": "flow_var_contracts_update"
            },
            "next_action": "${pipeline.next_action}"
        },    
        {
            "id": "insert_vulnerabilities",
            "action": "run",
            "data": {
                "inserted": "${flow.vuln_count_service(flow.session).get_or_create(flow.models,flow.vulnerabilities[0]._id,flow.contracts[0].contract,flow.vulnerabilities[0].count)}"
            },
            "next_action": "flow_var_vulnerabilities_update"
        },
        {
            "id": "flow_var_vulnerabilities_update",
            "action": "flow_var",
            "data": {
                "vulnerabilities": "${function.util.remove_from_dict(flow.vulnerabilities)}"
            },
            "next_action": "workspace_var_vulnerabilities_update"
        },
        {
            "id": "workspace_var_vulnerabilities_update",
            "action": "workspace_var",
            "data": {
                "vulnerabilities": null
            },
            "next_action": "check_var_vulnerabilities"
        },
        {
            "id": "flow_var_contracts_update",
            "action": "flow_var",
            "data": {
                "contracts": "${function.util.remove_from_dict(flow.contracts)}"
            },
            "next_action": "check_var_contracts"
        },
        {
            "id": "response_success",
            "action": "response",
            "data": {
                "data": {
                    "data": "${response.data}"
                }
            },
            "next_action": null
        }
    ]
}