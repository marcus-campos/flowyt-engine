{
    "id": "sapi-get-vuln",
    "name": "Get vulnerabilities",
    "pipeline": [
        {
            "action": "start",
            "data": {},
            "id": "start",
            "next_action": "mongodb_find"
        },
        {
            "id": "mongodb_find",
            "action": "mongodb",
            "data": {
                "collection": "vulnerabilities",
                "action": "aggregate",
                "conn_name": "socportal",
                "args": {
                    "pipeline": [
                        {
                            "$match": {
                                "numcontratoservicenow": "${workspace.contract}"
                            }
                        },
                        {
                            "$group": {
                                "_id": "$nomevuln",
                                "count": {
                                    "$sum": 1
                                }
                            }
                        }
                    ]
                }
            },
            "next_action": "workspace_var_vulnerabilities"
        },
        {
            "id": "workspace_var_vulnerabilities",
            "action": "workspace_var",
            "data": {
                "vulnerabilities": "${response.data}"
            },
            "next_action": "end"
        },
        {
            "id": "end",
            "action": "end",
            "data": {},
            "next_action": null
        }
    ]
}